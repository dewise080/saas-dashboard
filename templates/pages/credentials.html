{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Credentials{% endblock title %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">
    <div class="page-header">
      <div class="page-block">
        <div class="row align-items-center">
          <div class="col-md-12">
            <div class="page-header-title">
              <h5 class="mb-0">Credentials</h5>
            </div>
          </div>
          <div class="col-md-12">
            <ul class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="{% url 'apps.pages:index' %}">Home</a></li>
              <li class="breadcrumb-item" aria-current="page">Credentials</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- OpenAI Section -->
    <h5 class="mb-3"><i class="ti ti-brain text-success me-2"></i>OpenAI</h5>
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">OpenAI API Key</h5>
            <div id="openai-status-badge">
              {% if has_openai_key %}
                <span class="badge bg-success"><i class="ti ti-check me-1"></i>Assigned</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pending Assignment</span>
              {% endif %}
            </div>
          </div>
          <div class="card-body">
            {% if has_openai_key %}
              <div class="alert alert-success mb-3">
                <div class="d-flex align-items-center">
                  <i class="ti ti-key text-success me-3" style="font-size: 2rem;"></i>
                  <div>
                    <strong>API Key Assigned</strong>
                    <p class="mb-0 small">Your OpenAI API key was automatically assigned from our pool.</p>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Your API Key</label>
                <div class="input-group">
                  <input type="password" id="openai_api_key" class="form-control" 
                         value="{{ openai_key_preview }}" readonly>
                  <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('openai_api_key', this)">
                    <i class="ti ti-eye"></i>
                  </button>
                </div>
                {% if openai_key_assigned_at %}
                  <small class="text-muted">Assigned on {{ openai_key_assigned_at|date:"M d, Y H:i" }}</small>
                {% endif %}
              </div>
              
              <div class="alert alert-info mb-0">
                <i class="ti ti-info-circle me-2"></i>
                <small>This key is permanently assigned to your account and is used for AI-powered features.</small>
              </div>
            {% else %}
              <div class="alert alert-warning mb-3">
                <div class="d-flex align-items-center">
                  <i class="ti ti-hourglass text-warning me-3" style="font-size: 2rem;"></i>
                  <div>
                    <strong>API Key Pending</strong>
                    <p class="mb-0 small">An OpenAI API key will be automatically assigned to your account soon.</p>
                  </div>
                </div>
              </div>
              
              <div class="alert alert-info mb-0">
                <i class="ti ti-info-circle me-2"></i>
                <small>No action needed. Our system automatically assigns API keys from our pool when available.</small>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Telegram Section -->
    <h5 class="mb-3"><i class="ti ti-brand-telegram text-info me-2"></i>Telegram</h5>
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Connect Telegram</h5>
            {% if not has_api_key %}
              <span class="badge bg-warning text-dark ms-2">Missing API key</span>
            {% endif %}
          </div>
          <div class="card-body">
            <p class="text-muted">Enter a friendly name and your Telegram bot token to sync a credential into n8n.</p>
            <form method="post" class="row g-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="telegram">
              <div class="col-12">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-control" placeholder="My Telegram bot" required>
              </div>
              <div class="col-12">
                <label class="form-label">Telegram Token</label>
                <input type="text" name="token" class="form-control" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" required>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary" {% if not has_api_key %}disabled{% endif %}>Save to n8n</button>
              </div>
            </form>
            {% if not has_api_key %}
              <div class="alert alert-warning mt-3">
                {% if not has_profile %}
                  <i class="ti ti-alert-circle me-2"></i>
                  <strong>No n8n profile linked.</strong> Please contact support to link your account.
                {% else %}
                  <i class="ti ti-key me-2"></i>
                  <strong>No API key found.</strong> Please create an API key in your 
                  <a href="https://n8n.lotfinity.tech/settings/api" target="_blank" class="alert-link">n8n settings</a> 
                  to enable credential management.
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Saved Telegram Credentials</h5>
          </div>
          <div class="card-body">
            {% if credentials %}
              <div class="table-responsive">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>n8n ID</th>
                      <th>Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for cred in credentials %}
                      <tr>
                        <td>{{ cred.name }}</td>
                        <td><code>{{ cred.n8n_credential_id }}</code></td>
                        <td>{{ cred.created_at }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">No Telegram credentials saved yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- WhatsApp Section -->
    <h5 class="mb-3"><i class="ti ti-brand-whatsapp text-success me-2"></i>WhatsApp</h5>
    <div class="row">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Connect WhatsApp</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Enter a unique instance name and your WhatsApp number to create a new connection.</p>
            <form method="post" class="row g-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="whatsapp">
              <div class="col-12">
                <label class="form-label">Instance Name</label>
                <input type="text" name="instance_name" class="form-control" placeholder="my-whatsapp-bot" required pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, underscores and hyphens allowed">
                <small class="text-muted">Only letters, numbers, underscores and hyphens allowed</small>
              </div>
              <div class="col-12">
                <label class="form-label">WhatsApp Number</label>
                <input type="text" name="whatsapp_number" class="form-control" placeholder="+1234567890" required>
                <small class="text-muted">Include country code (e.g., 90 for Turkey 90xxxxxxxx , 1 for USA 1xxxxxxxxxx)</small>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-success">
                  <i class="ti ti-brand-whatsapp me-1"></i> Create Instance
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">WhatsApp Instances</h5>
          </div>
          <div class="card-body">
            {% if whatsapp_instances %}
              <div class="list-group">
                {% for item in whatsapp_instances %}
                  <div class="list-group-item">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        {% if item.profile_pic %}
                        <img src="{{ item.profile_pic }}" alt="Profile" class="rounded-circle me-3" width="48" height="48">
                        {% else %}
                        <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                          <i class="ti ti-brand-whatsapp text-success fs-4"></i>
                        </div>
                        {% endif %}
                        <div>
                          <h6 class="mb-0">{{ item.instance.instance_name }}</h6>
                          <small class="text-muted">{{ item.instance.whatsapp_number }}</small>
                          {% if item.profile_name %}
                          <br><small class="text-success"><i class="ti ti-user me-1"></i>{{ item.profile_name }}</small>
                          {% endif %}
                        </div>
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <!-- Live Status Badge -->
                        {% if item.is_connected %}
                          <span class="badge bg-success">
                            <i class="ti ti-check me-1"></i>Connected
                          </span>
                        {% elif item.live_status == 'connecting' %}
                          <span class="badge bg-warning text-dark">
                            <i class="ti ti-loader me-1"></i>Connecting
                          </span>
                        {% elif item.live_status == 'close' %}
                          <span class="badge bg-secondary">
                            <i class="ti ti-wifi-off me-1"></i>Disconnected
                          </span>
                        {% else %}
                          <span class="badge bg-secondary">
                            <i class="ti ti-question-mark me-1"></i>{{ item.live_status|default:"Unknown" }}
                          </span>
                        {% endif %}
                        
                        <!-- Actions -->
                        {% if item.is_connected %}
                          <a href="{% url 'apps.pages:whatsapp_dashboard' item.instance.instance_name %}" class="btn btn-sm btn-success">
                            <i class="ti ti-dashboard me-1"></i> Dashboard
                          </a>
                        {% else %}
                          <a href="{% url 'apps.pages:whatsapp_connect' item.instance.instance_name %}" class="btn btn-sm btn-outline-primary">
                            <i class="ti ti-qrcode me-1"></i> Connect
                          </a>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="mb-0 text-muted">No WhatsApp instances created yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
function togglePasswordVisibility(inputId, button) {
  const input = document.getElementById(inputId);
  const icon = button.querySelector('i');
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'ti ti-eye-off';
  } else {
    input.type = 'password';
    icon.className = 'ti ti-eye';
  }
}

function validateOpenAIKey() {
  const statusDiv = document.getElementById('openai-status');
  const statusAlert = document.getElementById('openai-status-alert');
  const statusIcon = document.getElementById('openai-status-icon');
  const statusTitle = document.getElementById('openai-status-title');
  const statusMessage = document.getElementById('openai-status-message');
  const statusBadge = document.getElementById('openai-status-badge');
  const modelsList = document.getElementById('openai-models-list');
  const modelsSpan = document.getElementById('openai-models');
  
  // Show loading state
  statusDiv.style.display = 'block';
  statusAlert.className = 'alert alert-secondary mb-0';
  statusIcon.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
  statusTitle.textContent = 'Validating...';
  statusMessage.textContent = 'Checking your OpenAI API key...';
  statusBadge.innerHTML = '<span class="badge bg-secondary">Checking...</span>';
  modelsList.style.display = 'none';
  
  fetch('{% url "apps.pages:validate_openai_key" %}')
    .then(response => response.json())
    .then(data => {
      statusDiv.style.display = 'block';
      
      if (data.valid) {
        statusAlert.className = 'alert alert-success mb-0';
        statusIcon.innerHTML = '<i class="ti ti-circle-check" style="font-size: 2rem; color: #198754;"></i>';
        statusTitle.textContent = 'Connected!';
        statusMessage.textContent = data.message;
        statusBadge.innerHTML = '<span class="badge bg-success"><i class="ti ti-check me-1"></i>Connected</span>';
        
        if (data.models && data.models.length > 0) {
          modelsList.style.display = 'block';
          modelsSpan.textContent = data.models.join(', ');
        }
      } else {
        let alertClass = 'alert-danger';
        let badgeClass = 'bg-danger';
        let iconHtml = '<i class="ti ti-circle-x" style="font-size: 2rem; color: #dc3545;"></i>';
        
        if (data.status === 'not_found') {
          alertClass = 'alert-warning';
          badgeClass = 'bg-warning text-dark';
          iconHtml = '<i class="ti ti-alert-triangle" style="font-size: 2rem; color: #ffc107;"></i>';
        } else if (data.status === 'rate_limited') {
          alertClass = 'alert-warning';
          badgeClass = 'bg-warning text-dark';
        }
        
        statusAlert.className = `alert ${alertClass} mb-0`;
        statusIcon.innerHTML = iconHtml;
        statusTitle.textContent = data.status === 'not_found' ? 'Not Configured' : 'Error';
        statusMessage.textContent = data.message;
        statusBadge.innerHTML = `<span class="badge ${badgeClass}">${data.status === 'invalid' ? 'Invalid Key' : data.status === 'not_found' ? 'Not configured' : 'Error'}</span>`;
        modelsList.style.display = 'none';
      }
    })
    .catch(error => {
      statusDiv.style.display = 'block';
      statusAlert.className = 'alert alert-danger mb-0';
      statusIcon.innerHTML = '<i class="ti ti-circle-x" style="font-size: 2rem; color: #dc3545;"></i>';
      statusTitle.textContent = 'Error';
      statusMessage.textContent = 'Failed to validate API key. Please try again.';
      statusBadge.innerHTML = '<span class="badge bg-danger">Error</span>';
      modelsList.style.display = 'none';
    });
}

// Auto-validate on page load if key exists
document.addEventListener('DOMContentLoaded', function() {
  const hasKey = document.getElementById('openai_api_key')?.dataset.hasKey;
  if (hasKey) {
    validateOpenAIKey();
  }
});
</script>
{% endblock javascripts %}
